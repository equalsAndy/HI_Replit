FROM node:18-alpine

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install only production dependencies and clear cache
RUN npm ci --only=production --no-audit --no-fund && \
    npm cache clean --force

# Copy built application (not source)
COPY dist ./dist
COPY shared ./shared

# Remove dev dependencies that might have been installed
RUN npm prune --production

# Set memory limit for Node.js
ENV NODE_OPTIONS="--max-old-space-size=512"

EXPOSE 8080

CMD ["node", "dist/index.js"]